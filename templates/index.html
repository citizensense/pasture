<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizen Sense Platform</title>
    
    <!-- GENERAL -->
    <link rel="stylesheet" href="/public/css/pure-min.css">

	<!-- GRAPH -->
	<link type="text/css" rel="stylesheet" href="/public/css/jquery-ui.css">
	<link type="text/css" rel="stylesheet" href="/public/css/graph.css">
	<link type="text/css" rel="stylesheet" href="/public/css/detail.css">
	<link type="text/css" rel="stylesheet" href="/public/css/legend.css">
	<!-- <link type="text/css" rel="stylesheet" href="/public/css/extensions.css"> <!--->
 	
 	<!-- MAP -->
	<link rel="stylesheet" href="/public/css/leaflet.css" />

    <!-- GENERAL -->
    <link rel="stylesheet" href="/public/css/ant.css" />

</head>

<body>

<div id="header">
	<h1 id="maintitle"><a href="#" class="pure-menu-heading">Frack Box</a></h1>
	<div id="mainmenu" class="pure-menu pure-menu-open pure-menu-horizontal">
	   	<ul>
	        <li><a id="uploadbutton" href="#">Upload</a></li> 
	        <li><a id="loginbutton" href="#">Sign In</a></li>
	    </ul>
	</div>
</div>

<div id="information" class="shadow">
    <div class="inner">
        <div id="nodelist" class="tab">
            <h2>Nodes</h2>
        </div>
        <div id="nodedata">
            <h2>Data</h2>
            <div class="content">nowt</div>
        </div>
         <div id="messages" class="tab">
            <h2>Messages</h2>
            <div id="messagebox">
            </div>
        </div>
        <div id="help">
            <h2>Help</h2>
        </div>
    </div>
</div>

<div id="map"></div>
<div id="charts"></div>

<!--
<div id="uploadform" class="centeredform">
    <form id="uploadformform" class="pure-form pure-form-stacked" action="/api" method="post" enctype="multipart/form-data">
        <fieldset>
            <legend>File Upload <a href="#">x</a></legend>
            <div class="pad">
                <label for="upload-gps">GPS (Click Map)</label>
                <input id="upload-gps" class="fullwidth" type="text" name="gps" value="">  
                
                <label for="file">Select file to upload</label>
                <input id="file" type="file" name="myFile" />

                <button id="upload" class="pure-button pure-button-primary">Upload</button>
            </div>
        </fieldset>
    </form>
</div>
-->
<div id="loginform" class="centeredform"> 
    <form class="pure-form pure-form-stacked">
        <fieldset>
            <legend>A Stacked Form</legend>
            <div class="pad">
                <label for="email">Email</label>
                <input id="email" type="email" placeholder="Email">

                <label for="password">Password</label>
                <input id="password" type="password" placeholder="Password">

                <label for="state">State</label>
                <select id="state">
                    <option>AL</option>
                    <option>CA</option>
                    <option>IL</option>
                </select>

                <label for="remember" class="pure-checkbox">
                    <input id="remember" type="checkbox"> Remember me
                </label>

                <button type="submit" class="pure-button pure-button-primary">Sign in</button>
            </div>
        </fieldset>
    </form>

</div>

<script src="/public/js/d3.v3.js"></script>
<script src="/public/js/jquery.min.js"></script>
<script>jQuery.noConflict();</script>
<script src="/public/js/jquery-ui.min.js"></script>
<script src="/public/js/Rickshaw.js"></script>
<script src="/public/js/Rickshaw.Class.js"></script>
<script src="/public/js/Rickshaw.Compat.ClassList.js"></script>
<script src="/public/js/Rickshaw.Graph.js"></script>
<script src="/public/js/Rickshaw.Graph.Renderer.js"></script>
<script src="/public/js/Rickshaw.Graph.Renderer.Area.js"></script>
<script src="/public/js/Rickshaw.Graph.Renderer.Line.js"></script>
<script src="/public/js/Rickshaw.Graph.Renderer.Bar.js"></script>
<script src="/public/js/Rickshaw.Graph.Renderer.ScatterPlot.js"></script>
<script src="/public/js/Rickshaw.Graph.Renderer.Stack.js"></script>
<script src="/public/js/Rickshaw.Graph.RangeSlider.js"></script>
<script src="/public/js/Rickshaw.Graph.RangeSlider.Preview.js"></script>
<script src="/public/js/Rickshaw.Graph.HoverDetail.js"></script>
<script src="/public/js/Rickshaw.Graph.Annotate.js"></script>
<script src="/public/js/Rickshaw.Graph.Legend.js"></script>
<script src="/public/js/Rickshaw.Graph.Axis.Time.js"></script>
<script src="/public/js/Rickshaw.Graph.Behavior.Series.Toggle.js"></script>
<script src="/public/js/Rickshaw.Graph.Behavior.Series.Order.js"></script>
<script src="/public/js/Rickshaw.Graph.Behavior.Series.Highlight.js"></script>
<script src="/public/js/Rickshaw.Graph.Smoother.js"></script>
<script src="/public/js/Rickshaw.Fixtures.Time.js"></script>
<script src="/public/js/Rickshaw.Fixtures.Time.Local.js"></script>
<script src="/public/js/Rickshaw.Fixtures.Number.js"></script>
<script src="/public/js/Rickshaw.Fixtures.RandomData.js"></script>
<script src="/public/js/Rickshaw.Fixtures.Color.js"></script>
<script src="/public/js/Rickshaw.Color.Palette.js"></script>
<script src="/public/js/Rickshaw.Graph.Axis.Y.js"></script>
<script src="/public/js/extensions.js"></script>
<script src="/public/js/graph.js"></script>
<script src="/public/js/leaflet.js"></script>

<script>
// MENU FUNCTIONS
jQuery(document).ready(function(){
    
    // INITIALISE & BUILD THE PAGE
    function init(){ 
        $ = jQuery;
        buildmenu();
        generatemap();
        loadnodes();
        submitmyform('#uploadformform');
        // Create the graphs
        //var mygraph = new Graphkit("chart1", 100);  // id, height, data
        //mygraph.testdata();
    }

    // MAIN MENU CONTROLS
    function buildmenu(){
        // Show/Hide upload form
        $("#uploadbutton").click(function(){
            $('#loginform').hide(); 
            $("#uploadform").toggle();
        });
        $('#uploadbutton').toggle(function () {
            $('#uploadform').hide();
        }, function () {
            $('#uploadform').show();
        });

        // Show / Hide login form
        $("#loginbutton").click(function(){
            $('#uploadform').hide();   
            $("#logininform").toggle();
        });
        $('#loginform').toggle(function () {
            $('#loginform').hide();
        }, function () {
            $('#loginform').show();
        });
    }

    // LOAD NODES
    function loadnodes(){
        $.ajax({
            url: '/api/view/all',
            type: 'GET',
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success: function (str) {
                var data = JSON.parse(str);
                displaynodes(data);
            }
        });
    }
    
    // DISPLAY LIST OF NODES ON THE MAP
    function displaynodes(data){
        $.each(data, function( index, value ) {
            $("#messagebox").prepend('<hr>'+index+':'+value[0]);
            var latlng = [value[0], value[1]];
            var mark=L.marker(latlng, {icon:frackBox, data:'test'}).on('click', onClick).addTo(map);
            function onClick(e) {
                console.log(e);
                var content = e.test;
                $('#nodedata .content').html('sss'+content);
            } 
        });
    }

    // SUBMIT UPLOAD FORM
    function submitmyform(formid){
        $(formid).submit(function(event){
            //disable the default form submission
            event.preventDefault();
            //grab all form data  
            var formData = new FormData($(this)[0]);
            $.ajax({
                url: '/api/create',
                type: 'POST',
                data: formData,
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    $("#messagebox").prepend('<div class="msg">'+data+'</div>');  
                }
            });
            return false;
        });
    }
    
    // GENERATE THE MAP & MAP CONTROLS
    function generatemap(){ 
        // Setup the base map
        map = L.map('map').setView([51.505, -0.09], 13);
        var tilelayer = "http://{s}.tiles.mapbox.com/v3/openplans.map-g4j0dszr/{z}/{x}/{y}.png";
        //var tilelayer = "http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg"; //L.control.scale().addTo(map);
        L.tileLayer(tilelayer, {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18
        }).addTo(map);
        // Define an icon. Images sourced from: http://preloaders.net
        frackBox = L.icon({
            iconUrl: '/public/images/29.gif',
            shadowUrl: 'public/images/shadow.png',
            iconSize:     [23, 23], // size of the icon
            shadowSize:   [50, 50], // size of the shadow
            iconAnchor:   [-8, -8], // point of the icon which will correspond to marker's location
            shadowAnchor: [0, 0],  // the same for the shadow
            popupAnchor:  [20, 0] // point from which the popup should open relative to the iconAnchor
        });
        map.on('click', onMapClick);
    }
    /*  Add a popup. Example usage: addpopup([51.54193, 0.71995], "A message <strong>to</strong> display."); */
    function addpopup(latlng, content) { 
        thispopup = L.popup();   
        return thispopup.setLatLng(latlng).setContent(content).addTo(map);
    } 
    /* 	Perform function when map is clicked: Example: map.on('click', onMapClick);   */   
    function onMapClick(e) { 
        var str = e.latlng.toString().replace('LatLng(', '').replace(')', '').replace(' ', '');
        jQuery('#upload-gps').val(str);
        return addpopup(e.latlng, "You clicked the map at:<br />" + e.latlng.toString())     
    }  
       
    // BUILD THE PAGE
    init();
    
});

</script>

</body></html>
